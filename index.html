<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinador de Instrumentos de Cuerda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzicato/0.6.4/Pizzicato.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .needle {
            transform-origin: 50% 100%;
            transition: transform 0.5s ease;
        }
        .string-indicator {
            transition: all 0.3s ease;
        }
        .active-string {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
            transform: scale(1.05);
        }
        .meter-container {
            perspective: 1000px;
        }
        .meter {
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }
        .frequency-display {
            font-family: 'Courier New', monospace;
        }
        .tuner-container {
            background: radial-gradient(circle, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 100%);
        }
        .string-selector-btn {
            transition: all 0.2s ease;
        }
        .string-selector-btn:hover {
            transform: translateY(-3px);
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .listening-animation {
            animation: pulse 1.5s infinite;
        }
        .green-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20%;
            height: 10px;
            background-color: rgba(74, 222, 128, 0.3);
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">
    <header class="bg-slate-800 py-4 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center text-blue-400">
                <i class="fas fa-guitar mr-2"></i> Afinador Profesional
            </h1>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-3xl mx-auto tuner-container rounded-2xl p-6 shadow-xl">
            <div class="mb-8 text-center">
                <h2 class="text-2xl font-semibold mb-2">Selecciona tu instrumento</h2>
                <div class="flex justify-center space-x-4 mb-6">
                    <button id="guitar-btn" class="string-selector-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-guitar mr-2"></i> Guitarra
                    </button>
                    <button id="bass-btn" class="string-selector-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-guitar-electric mr-2"></i> Bajo
                    </button>
                    <button id="violin-btn" class="string-selector-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-violin mr-2"></i> Violín
                    </button>
                    <button id="ukulele-btn" class="string-selector-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-music mr-2"></i> Ukelele
                    </button>
                </div>

                <div id="instrument-info" class="bg-slate-700 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-medium mb-2" id="instrument-name">Guitarra Estándar</h3>
                    <p class="text-slate-300" id="instrument-tuning">Afinación: E2 A2 D3 G3 B3 E4</p>
                </div>
            </div>

            <div class="meter-container bg-slate-800 rounded-xl p-6 mb-8">
                <div class="relative h-64 mb-8">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-full h-1 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full"></div>
                        <div class="green-zone"></div>
                    </div>
                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2">
                        <div class="needle w-1 h-24 bg-white rounded-full" style="transform: rotate(0deg);"></div>
                    </div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">
                        <span id="current-note">--</span>
                    </div>
                </div>

                <div class="flex justify-between mb-2">
                    <span class="text-red-400 font-medium">Demasiado bajo</span>
                    <span class="text-green-400 font-medium">Afinado (±5 cents)</span>
                    <span class="text-red-400 font-medium">Demasiado alto</span>
                </div>

                <div class="text-center mb-6">
                    <div class="inline-block bg-slate-700 px-4 py-2 rounded-lg">
                        <span class="font-mono frequency-display text-xl">
                            Frecuencia: <span id="frequency">0</span> Hz
                        </span>
                    </div>
                </div>

                <div class="text-center">
                    <button id="listen-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-lg font-semibold flex items-center mx-auto">
                        <i class="fas fa-microphone mr-2"></i> <span id="listen-text">Iniciar Afinado</span>
                    </button>
                    <p id="listening-status" class="mt-2 text-blue-300 listening-animation hidden">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Escuchando...
                    </p>
                    <p id="detection-status" class="mt-2 text-yellow-300 hidden">
                        <i class="fas fa-info-circle mr-2"></i> Toca una cuerda clara y sostenida
                    </p>
                </div>
            </div>

            <div id="strings-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Las cuerdas se generarán dinámicamente aquí -->
            </div>
        </div>

        <div class="mt-8 bg-slate-800 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 text-center">Instrucciones</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-700 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-300 mb-2"><i class="fas fa-microphone mr-2"></i>Paso 1</h3>
                    <p>Selecciona tu instrumento y haz clic en "Iniciar Afinación". Permite el acceso al micrófono cuando se solicite.</p>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-300 mb-2"><i class="fas fa-music mr-2"></i>Paso 2</h3>
                    <p>Toca una cuerda al aire de forma clara y sostenida. La aplicación detectará automáticamente qué cuerda estás tocando.</p>
                </div>
                <div class="bg-slate-700 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-300 mb-2"><i class="fas fa-tools mr-2"></i>Paso 3</h3>
                    <p>Ajusta la tensión de la cuerda según las indicaciones hasta que la aguja esté en la zona verde (±5 cents).</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-slate-400">
            <p>Afinador con fines pedagógicos. Profesor Manuel Puebla Vega &copy; 2025</p>
        </div>
    </footer>

    <script>
        // Configuraciones de instrumentos
        const instruments = {
            guitar: {
                name: "Guitarra Estándar",
                tuning: "E2 A2 D3 G3 B3 E4",
                strings: [
                    { note: "E", frequency: 82.41, octave: 2, stringNumber: 6 },
                    { note: "A", frequency: 110.00, octave: 2, stringNumber: 5 },
                    { note: "D", frequency: 146.83, octave: 3, stringNumber: 4 },
                    { note: "G", frequency: 196.00, octave: 3, stringNumber: 3 },
                    { note: "B", frequency: 246.94, octave: 3, stringNumber: 2 },
                    { note: "E", frequency: 329.63, octave: 4, stringNumber: 1 }
                ]
            },
            bass: {
                name: "Bajo Estándar",
                tuning: "E1 A1 D2 G2",
                strings: [
                    { note: "E", frequency: 41.20, octave: 1, stringNumber: 4 },
                    { note: "A", frequency: 55.00, octave: 1, stringNumber: 3 },
                    { note: "D", frequency: 73.42, octave: 2, stringNumber: 2 },
                    { note: "G", frequency: 98.00, octave: 2, stringNumber: 1 }
                ]
            },
            violin: {
                name: "Violín Estándar",
                tuning: "G3 D4 A4 E5",
                strings: [
                    { note: "G", frequency: 196.00, octave: 3, stringNumber: 4 },
                    { note: "D", frequency: 293.66, octave: 4, stringNumber: 3 },
                    { note: "A", frequency: 440.00, octave: 4, stringNumber: 2 },
                    { note: "E", frequency: 659.25, octave: 5, stringNumber: 1 }
                ]
            },
            ukulele: {
                name: "Ukelele Estándar",
                tuning: "G4 C4 E4 A4",
                strings: [
                    { note: "G", frequency: 392.00, octave: 4, stringNumber: 4 },
                    { note: "C", frequency: 261.63, octave: 4, stringNumber: 3 },
                    { note: "E", frequency: 329.63, octave: 4, stringNumber: 2 },
                    { note: "A", frequency: 440.00, octave: 4, stringNumber: 1 }
                ]
            }
        };

        // Variables globales
        let currentInstrument = 'guitar';
        let audioContext;
        let analyser;
        let microphone;
        let isListening = false;
        let currentString = null;
        let animationId;
        let lastStableFrequency = 0;
        let stableCount = 0;
        let lastUpdateTime = 0;

        // Elementos del DOM
        const guitarBtn = document.getElementById('guitar-btn');
        const bassBtn = document.getElementById('bass-btn');
        const violinBtn = document.getElementById('violin-btn');
        const ukuleleBtn = document.getElementById('ukulele-btn');
        const instrumentName = document.getElementById('instrument-name');
        const instrumentTuning = document.getElementById('instrument-tuning');
        const listenBtn = document.getElementById('listen-btn');
        const listenText = document.getElementById('listen-text');
        const listeningStatus = document.getElementById('listening-status');
        const detectionStatus = document.getElementById('detection-status');
        const currentNoteElement = document.getElementById('current-note');
        const frequencyElement = document.getElementById('frequency');
        const stringsContainer = document.getElementById('strings-container');
        const needle = document.querySelector('.needle');

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            setupInstrument(currentInstrument);
            setupEventListeners();
        });

        // Configurar los listeners de eventos
        function setupEventListeners() {
            guitarBtn.addEventListener('click', () => setupInstrument('guitar'));
            bassBtn.addEventListener('click', () => setupInstrument('bass'));
            violinBtn.addEventListener('click', () => setupInstrument('violin'));
            ukuleleBtn.addEventListener('click', () => setupInstrument('ukulele'));
            listenBtn.addEventListener('click', toggleListening);
        }

        // Configurar un instrumento específico
        function setupInstrument(instrument) {
            currentInstrument = instrument;
            const instrumentData = instruments[instrument];
            
            // Actualizar la información del instrumento
            instrumentName.textContent = instrumentData.name;
            instrumentTuning.textContent = `Afinación: ${instrumentData.tuning}`;
            
            // Resaltar el botón del instrumento activo
            document.querySelectorAll('.string-selector-btn').forEach(btn => {
                btn.classList.remove('bg-blue-700', 'ring-2', 'ring-blue-400');
                btn.classList.add('bg-blue-600');
            });
            
            const activeBtn = document.getElementById(`${instrument}-btn`);
            activeBtn.classList.remove('bg-blue-600');
            activeBtn.classList.add('bg-blue-700', 'ring-2', 'ring-blue-400');
            
            // Generar las cuerdas del instrumento
            generateStrings(instrumentData.strings);
        }

        // Generar las cuerdas del instrumento en la interfaz
        function generateStrings(strings) {
            stringsContainer.innerHTML = '';
            
            strings.forEach(string => {
                const stringElement = document.createElement('div');
                stringElement.className = 'bg-slate-700 p-4 rounded-lg string-indicator';
                stringElement.dataset.note = string.note;
                stringElement.dataset.frequency = string.frequency;
                stringElement.dataset.octave = string.octave;
                stringElement.dataset.stringNumber = string.stringNumber;
                
                stringElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg">Cuerda ${string.stringNumber}</span>
                        <span class="bg-slate-600 px-2 py-1 rounded text-sm">${string.note}${string.octave}</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <div class="w-4 h-4 rounded-full bg-gray-500 mr-2 string-status-light"></div>
                        <span class="text-sm string-status-text">No detectada</span>
                    </div>
                    <div class="text-sm string-instruction">Toca la cuerda clara y sostenida</div>
                `;
                
                stringsContainer.appendChild(stringElement);
            });
        }

        // Alternar el estado de escucha
        function toggleListening() {
            if (isListening) {
                stopListening();
                listenText.textContent = 'Iniciar Afinado';
                listeningStatus.classList.add('hidden');
                detectionStatus.classList.add('hidden');
                listenBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                listenBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                startListening();
                listenText.textContent = 'Detener Afinado';
                listeningStatus.classList.remove('hidden');
                detectionStatus.classList.remove('hidden');
                listenBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                listenBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            }
            
            isListening = !isListening;
        }

        // Iniciar el proceso de escucha
        function startListening() {
            // Crear contexto de audio si no existe
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096; // Mayor resolución para mejor detección
            }
            
            // Solicitar acceso al micrófono
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    
                    // Resetear estado de detección
                    lastStableFrequency = 0;
                    stableCount = 0;
                    lastUpdateTime = 0;
                    
                    // Iniciar el análisis de frecuencia
                    analyzeFrequency();
                })
                .catch(err => {
                    console.error('Error al acceder al micrófono:', err);
                    alert('No se pudo acceder al micrófono. Asegúrate de haber dado los permisos necesarios.');
                    isListening = false;
                    listenText.textContent = 'Iniciar Afinado';
                    listeningStatus.classList.add('hidden');
                    detectionStatus.classList.add('hidden');
                    listenBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    listenBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                });
        }

        // Detener el proceso de escucha
        function stopListening() {
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Resetear la interfaz
            currentNoteElement.textContent = '--';
            frequencyElement.textContent = '0';
            needle.style.transform = 'rotate(0deg)';
            
            // Resetear las cuerdas
            document.querySelectorAll('.string-indicator').forEach(string => {
                string.classList.remove('active-string');
                const statusLight = string.querySelector('.string-status-light');
                const statusText = string.querySelector('.string-status-text');
                const instruction = string.querySelector('.string-instruction');
                
                statusLight.className = 'w-4 h-4 rounded-full bg-gray-500 mr-2 string-status-light';
                statusText.textContent = 'No detectada';
                statusText.className = 'text-sm string-status-text';
                instruction.textContent = 'Toca la cuerda clara y sostenida';
                instruction.className = 'text-sm string-instruction';
            });
        }

        // Analizar la frecuencia del sonido
        function analyzeFrequency() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // Encontrar la frecuencia dominante con mayor precisión
            let maxAmplitude = 0;
            let maxIndex = 0;
            
            // Solo analizar frecuencias entre 20Hz y 2000Hz (rango útil para instrumentos)
            const minFrequency = 20;
            const maxFrequency = 2000;
            const minIndex = Math.floor(minFrequency * analyser.fftSize / audioContext.sampleRate);
            const maxIndexLimit = Math.floor(maxFrequency * analyser.fftSize / audioContext.sampleRate);
            
            for (let i = minIndex; i < maxIndexLimit; i++) {
                if (dataArray[i] > maxAmplitude) {
                    maxAmplitude = dataArray[i];
                    maxIndex = i;
                }
            }
            
            // Calcular la frecuencia en Hz
            const frequency = maxIndex * audioContext.sampleRate / analyser.fftSize;
            
            // Solo actualizar si hay suficiente amplitud (sonido claro)
            if (maxAmplitude > 50) {
                const now = performance.now();
                
                // Verificar estabilidad de la frecuencia
                if (Math.abs(frequency - lastStableFrequency) < 2 && now - lastUpdateTime < 200) {
                    stableCount++;
                } else {
                    stableCount = 0;
                }
                
                lastStableFrequency = frequency;
                lastUpdateTime = now;
                
                // Solo actualizar la interfaz si la frecuencia es estable
                if (stableCount > 3) {
                    updateUI(frequency);
                }
            } else {
                // Si no hay suficiente amplitud, resetear
                if (performance.now() - lastUpdateTime > 500) {
                    resetUI();
                }
            }
            
            // Continuar el análisis
            animationId = requestAnimationFrame(analyzeFrequency);
        }

        // Resetear la interfaz cuando no hay sonido claro
        function resetUI() {
            currentNoteElement.textContent = '--';
            frequencyElement.textContent = '0';
            needle.style.transform = 'rotate(0deg)';
            
            document.querySelectorAll('.string-indicator').forEach(string => {
                string.classList.remove('active-string');
                const statusLight = string.querySelector('.string-status-light');
                const statusText = string.querySelector('.string-status-text');
                const instruction = string.querySelector('.string-instruction');
                
                statusLight.className = 'w-4 h-4 rounded-full bg-gray-500 mr-2 string-status-light';
                statusText.textContent = 'No detectada';
                statusText.className = 'text-sm string-status-text';
                instruction.textContent = 'Toca la cuerda clara y sostenida';
                instruction.className = 'text-sm string-instruction';
            });
        }

        // Actualizar la interfaz con la información de frecuencia
        function updateUI(frequency) {
            frequencyElement.textContent = frequency.toFixed(2);
            
            // Encontrar la cuerda más cercana
            const strings = instruments[currentInstrument].strings;
            let closestString = null;
            let smallestDiff = Infinity;
            
            strings.forEach(string => {
                const diff = Math.abs(frequency - string.frequency);
                if (diff < smallestDiff) {
                    smallestDiff = diff;
                    closestString = string;
                }
            });
            
            // Calcular la diferencia en cents (100 cents = 1 semitono)
            const cents = 1200 * Math.log2(frequency / closestString.frequency);
            
            // Determinar si está afinado (±5 cents de tolerancia)
            const isInRange = Math.abs(cents) <= 5;
            
            // Actualizar la nota actual
            currentNoteElement.textContent = closestString.note + closestString.octave;
            
            // Actualizar la aguja del afinador
            const maxAngle = 45; // Máximo ángulo en grados
            let angle = (cents / 50) * maxAngle; // 50 cents = ángulo máximo
            angle = Math.max(-maxAngle, Math.min(maxAngle, angle));
            needle.style.transform = `rotate(${angle}deg)`;
            
            // Actualizar el estado de las cuerdas
            updateStringStatus(closestString, frequency, cents, isInRange);
        }

        // Actualizar el estado de una cuerda específica
        function updateStringStatus(string, frequency, cents, isInRange) {
            const stringElement = document.querySelector(`.string-indicator[data-string-number="${string.stringNumber}"]`);
            
            if (!stringElement) return;
            
            // Resaltar la cuerda activa
            document.querySelectorAll('.string-indicator').forEach(el => {
                el.classList.remove('active-string');
            });
            stringElement.classList.add('active-string');
            
            const statusLight = stringElement.querySelector('.string-status-light');
            const statusText = stringElement.querySelector('.string-status-text');
            const instruction = stringElement.querySelector('.string-instruction');
            
            // Cambiar el color según el estado de afinación
            if (isInRange) {
                statusLight.className = 'w-4 h-4 rounded-full bg-green-500 mr-2 string-status-light';
                statusText.textContent = 'Afinada';
                statusText.className = 'text-sm string-status-text text-green-400';
                instruction.textContent = '¡Perfecto! La cuerda está afinada';
                instruction.className = 'text-sm string-instruction text-green-400';
            } else {
                if (frequency < string.frequency) {
                    statusLight.className = 'w-4 h-4 rounded-full bg-red-500 mr-2 string-status-light';
                    statusText.textContent = 'Demasiado bajo';
                    statusText.className = 'text-sm string-status-text text-red-400';
                    instruction.textContent = `Aprieta la cuerda (${Math.abs(cents.toFixed(1))} cents bajo)`;
                    instruction.className = 'text-sm string-instruction text-red-400';
                } else {
                    statusLight.className = 'w-4 h-4 rounded-full bg-yellow-500 mr-2 string-status-light';
                    statusText.textContent = 'Demasiado alto';
                    statusText.className = 'text-sm string-status-text text-yellow-400';
                    instruction.textContent = `Afloja la cuerda (${cents.toFixed(1)} cents alto)`;
                    instruction.className = 'text-sm string-instruction text-yellow-400';
                }
            }
        }
    </script>
</body>
</html>